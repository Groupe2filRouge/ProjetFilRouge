AWSTemplateFormatVersion: 2010-09-09
Description: CloudFormation template for jenkins-groupe2-filrouge

Resources:
  myVPC:
    Type: AWS::EC2::VPC
    Properties: 
      CidrBlock: 172.31.0.0/24
      InstanceTenancy: default
      EnableDnsSupport: true
      EnableDnsHostnames: true
      # Tags: 
      #   - Key: stack
      #     Value: vpc-jenkins-groupe2-filrouge

  
  myInternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties: 
      Tags: 
        - Key: stack
          Value: gateway-jenkins-groupe2-filrouge

  AttachGateway:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId:
        Ref: myVPC
      InternetGatewayId:
        Ref: myInternetGateway

  myRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId:  
        Ref: myVPC
      # Tags:
      # - Key: stack
      #   Value: routetable-jenkins-groupe2-filrouge

  myRoute:
    Type: AWS::EC2::Route
    DependsOn: myInternetGateway
    Properties:
       RouteTableId:
         Ref: myRouteTable
       DestinationCidrBlock: 0.0.0.0/0
       GatewayId:
         Ref: myInternetGateway

  mySubnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId:
        Ref: myVPC
      CidrBlock: 172.31.0.0/24
      AvailabilityZone: "eu-west-3a"
      MapPublicIpOnLaunch: true
      # Tags:
      # - Key: stack
      #   Value: subnet-jenkins-groupe2-filrouge

  mySubnetRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId:
        Ref: mySubnet
      RouteTableId:
        Ref: myRouteTable

  mySecurityGroup:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
        GroupDescription: Base Security Group
        VpcId:
          Ref: myVPC
        SecurityGroupIngress:
          - IpProtocol: tcp
            CidrIp: 0.0.0.0/0
            FromPort: 22
            ToPort: 22
          - IpProtocol: tcp
            CidrIp: 0.0.0.0/0
            FromPort: 80
            ToPort: 80
          - IpProtocol: tcp
            FromPort: 8080
            ToPort: 8080
            CidrIp: 0.0.0.0/0
            
  Ec2Instance: 
    Type: AWS::EC2::Instance
    Properties: 
      InstanceType : t2.micro
      ImageId: ami-0f7cd40eac2214b37
      KeyName: vm-jenkins-groupe2-filrouge
      NetworkInterfaces: 
        - AssociatePublicIpAddress: true
          DeviceIndex: 0
          GroupSet: 
            - Ref: mySecurityGroup
          SubnetId: 
            Ref: mySubnet
      Tags: 
        - Key: Name
          Value: vm-jenkins-groupe2-filrouge
      UserData: 
        Fn::Base64: !Sub |
          #!/bin/bash -xe
          apt-get update # good practice to update existing packages          
          apt-get install -y openjdk-11-jdk python3-venv python3-pip git
          wget -q -O - https://pkg.jenkins.io/debian-stable/jenkins.io.key | sudo apt-key add -
          sh -c 'echo deb https://pkg.jenkins.io/debian-stable binary/ | sudo tee /etc/apt/sources.list.d/jenkins.list'
          apt-get update
          apt-get install -y jenkins
          apt-get install -y apt-transport-https ca-certificates curl gnupg lsb-release
          curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --yes --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
          echo "deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
          apt-get update
          apt-get install -y docker-ce docker-ce-cli containerd.io
          usermod -aG docker jenkins